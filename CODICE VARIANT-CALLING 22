CODICE VARIANT- CALLING CROMOSOMA 22

Mi collego alla macchina virtuale cliccando sul link email container VScode 
Inserisci password:     student

Clicca su Open a folder to start

Cancella quello che mi esce scritto sulla barra in alto e scrivi sulla barra in 
alto:

/config/workspace/             se voglio rimanere nell’interfaccia generale

/config/workspace/datiesame    se voglio entrare direttamente in dati esame  

CHIUDO LA PAGINA WELCOME CHE MI ESCE DALLA X

APRO NUOVO TERMINALE IN ALTO A SINISTRA:    menù a tendina →  terminal →  new terminal


• PREPARAZIONE DELLE CARTELLE

pwd → config/workspace

cd /config/workspace

mkdir -p analysis

cd analysis

mkdir -p raw_data

cd raw_data

spacchetto i dati: tar -xvzf data_resequencing.tar.gz -C .

(metto il punto dopo C , perchè gli sto dicendo di spacchettare i file dove mi trovo, ossia in raw_data. 
Se mi trovassi in analysis, ma volevo spacchettare in raw_data allora: tar -xvzf data_rnaseq.tar.gz -C raw_data/ )

ls -l (vedo se ci sono sotto raw_data i files fastq di caso e controllo)

cd .. (torno in analysis)

mkdir -p alignment

cd alignment

(terminata la preparazione delle cartelle, inizio con l' allineamento dentro la cartella alignment)

• ALIGNMENT

(eseguo BWA per il controllo) NB: SE SI USA CROMOSOMA 21 ALLORA CAMBIA 

bwa mem \
-t 2 \
-R "@RG\tID:sim\tSM:normal\tPL:illumina\tLB:sim" \
/config/workspace/datiesame/reference_chr22/sequence/Homo_sapiens_assembly38_chr22.fasta \
/config/workspace/analysis/raw_data/normal_1.000+disease_0.000_1.fq.gz \
/config/workspace/analysis/raw_data/normal_1.000+disease_0.000_2.fq.gz \
| samtools view -@ 8 -bhS -o normal.bam -

(Eseguo BWA per il malato)  NB: SE SI USA CROMOSOMA 21 ALLORA CAMBIA 

bwa mem \
-t 2 \
-R "@RG\tID:sim\tSM:disease\tPL:illumina\tLB:sim" \
/config/workspace/datiesame/reference_chr22/sequence/Homo_sapiens_assembly38_chr22.fasta \
/config/workspace/analysis/raw_data/normal_0.000+disease_1.000_1.fq.gz \
/config/workspace/analysis/raw_data/normal_0.000+disease_1.000_2.fq.gz \
| samtools view -@ 8 -bhS -o disease.bam -

samtools sort -o normal_sorted.bam normal.bam
samtools sort -o disease_sorted.bam disease.bam

samtools index normal_sorted.bam
samtools index disease_sorted.bam

gatk MarkDuplicates \
-I normal_sorted.bam \
-M normal_metrics.txt \
-O normal_md.bam

gatk MarkDuplicates \
-I disease_sorted.bam \
-M disease_metrics.txt \
-O disease_md.bam

NB: SE USO CROMOSOMA 21 CAMBIA NUMERO NEL PATH

gatk BaseRecalibrator \
   -I normal_md.bam \
   -R /config/workspace/datiesame/reference_chr22/sequence/Homo_sapiens_assembly38_chr22.fasta \
   --known-sites /config/workspace/datiesame/reference_chr22/gatkbundle/dbsnp_146.hg38_chr22.vcf.gz \
   --known-sites /config/workspace/datiesame/reference_chr22/gatkbundle/Mills_and_1000G_gold_standard.indels.hg38_chr22.vcf.gz \
   -O normal_recal_data.table

gatk BaseRecalibrator \
   -I disease_md.bam \
   -R /config/workspace/datiesame/reference_chr22/sequence/Homo_sapiens_assembly38_chr22.fasta \
   --known-sites /config/workspace/datiesame/reference_chr22/gatkbundle/dbsnp_146.hg38_chr22.vcf.gz \
   --known-sites /config/workspace/datiesame/reference_chr22/gatkbundle/Mills_and_1000G_gold_standard.indels.hg38_chr22.vcf.gz \
   -O disease_recal_data.table


NB: SE USO CROMOSOMA 21 CAMBIA NUMERO NEL PATH

gatk ApplyBQSR \
   -R /config/workspace/datiesame/reference_chr22/sequence/Homo_sapiens_assembly38_chr22.fasta \
   -I normal_md.bam \
   --bqsr-recal-file normal_recal_data.table \
   -O normal_recal.bam

gatk ApplyBQSR \
   -R /config/workspace/datiesame/reference_chr22/sequence/Homo_sapiens_assembly38_chr22.fasta \
   -I disease_md.bam \
   --bqsr-recal-file disease_recal_data.table \
   -O disease_recal.bam


• VARIANT CALLING


cd /config/workspace

mkdir -p analysis/variants

cd analysis/variants

NB: SE USO CROMOSOMA 22 ALLORA CAMBIA NUMERO NEL PATH

gatk --java-options "-Xmx4g" HaplotypeCaller  \
   -R /config/workspace/datiesame/reference_chr22/sequence/Homo_sapiens_assembly38_chr22.fasta \
   -I /config/workspace/analysis/alignment/normal_recal.bam \
   -O normal.g.vcf.gz \
   -ERC GVCF


gatk --java-options "-Xmx4g" HaplotypeCaller  \
   -R /config/workspace/datiesame/reference_chr22/sequence/Homo_sapiens_assembly38_chr22.fasta \
   -I /config/workspace/analysis/alignment/disease_recal.bam \
   -O disease.g.vcf.gz \
   -ERC GVCF


mkdir -p tmp         (NON DEVO ENTRARCI)

NB: SE USO CROMOSOMA 22 ALLORA CAMBIA NUMERO NEL PATH

gatk --java-options "-Xmx4g -Xms4g" GenomicsDBImport \
      -V normal.g.vcf.gz \
      -V disease.g.vcf.gz \
      --genomicsdb-workspace-path compared_db \
      --tmp-dir /config/workspace/analysis/variants/tmp \
      -L chr22

gatk --java-options "-Xmx4g" GenotypeGVCFs \
   -R /config/workspace/datiesame/reference_chr22/sequence/Homo_sapiens_assembly38_chr22.fasta \
   -V gendb://compared_db \
   --dbsnp /config/workspace/datiesame/reference_chr22/gatkbundle/dbsnp_146.hg38_chr22.vcf.gz \
   -O results.vcf.gz


• ANNOTAZIONE DELLE VARIANTI

mkdir -p /config/workspace/analysis/variants/cache

cd /config/workspace/analysis/variants

snpEff -Xmx4g ann -v hg38 results.vcf.gz >results_ann.vcf

cat results_ann.vcf | grep "#CHROM" | cut -f 10-

SnpSift filter "ANN[0].IMPACT = 'HIGH' && isRef(GEN[1]) && (isVariant(GEN[0]) | isHom(GEN[0]))" results_ann.vcf >filtered_variants.vcf


SnpSift extractFields \
-s "," -e "." \
filtered_variants.vcf \
"CHROM" "POS" "ID" "GEN[disease].GT" "GEN[normal].GT" ANN[*].GENE ANN[*].EFFECT \
| column -t


SnpSift extractFields \
-s "," -e "." \
filtered_variants.vcf \
"CHROM" "POS" "ID" "REF" "ALT" "GEN[*].GT" ANN[0].GENE ANN[0].EFFECT \
| column -t


